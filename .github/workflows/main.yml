name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'  # Run when you push a tag starting with 'v'

jobs:
  build-windows:
    runs-on: windows-latest  # This uses Windows Server
    
    steps:
    # Step 1: Checkout code
    - name: Checkout code
      uses: actions/checkout@v3
    
    # Step 2: Set up Python
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    # Step 4: Create empty files if they don't exist
    - name: Create required files
      run: |
        if not exist "event_manager.log" echo. > event_manager.log
        if not exist "guest_master_list.csv" echo. > guest_master_list.csv
        if not exist "event_attendance.csv" echo. > event_attendance.csv
        if not exist "invitation_cards" mkdir invitation_cards
    
    # Step 5: Build executable
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name="EventManagerPro" ^
          --add-data="event_manager.log;." ^
          --add-data="guest_master_list.csv;." ^
          --add-data="event_attendance.csv;." ^
          --add-data="invitation_cards;invitation_cards" ^
          --hidden-import=PIL ^
          --hidden-import=PIL._tkinter_finder ^
          --hidden-import=email.mime.multipart ^
          --hidden-import=email.mime.text ^
          --hidden-import=email.mime.image ^
          --hidden-import=pandas._libs.tslibs.timedeltas ^
          --hidden-import=pandas._libs.tslibs.nattype ^
          --hidden-import=numpy ^
          --clean ^
          main.py
    
    # Step 6: Upload artifact
    - name: Upload executable
      uses: actions/upload-artifact@v3
      with:
        name: EventManagerPro-Windows
        path: dist/EventManagerPro.exe
        retention-days: 7
    
    # Step 7: Create GitHub Release
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/EventManagerPro.exe
        generate_release_notes: true
